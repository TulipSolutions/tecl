From cf65e14d21f8ab3cef4afb2202ce153a78ab2db7 Mon Sep 17 00:00:00 2001
From: Gert van Dijk <gert.vandijk@tulipsolutions.nl>
Date: Sat, 1 Feb 2020 00:04:54 +0100
Subject: [PATCH 1/2] Strip virtual imports directory from proto path

Fix for issue: https://github.com/stackb/rules_proto/issues/143
---
 compile.bzl | 33 +++++++++++++++++++++++++++++++--
 1 file changed, 31 insertions(+), 2 deletions(-)

diff --git compile.bzl compile.bzl
index 4f1d32c..1d0c96d 100644
--- compile.bzl
+++ compile.bzl
@@ -196,6 +196,11 @@ def _get_proto_filename(src):
         return "/".join(parts[2:])
     return src.short_path
 
+def _strip_virtual_import(path):
+      pos = path.find(_VIRTUAL_IMPORTS)
+      path = path[pos + len(_VIRTUAL_IMPORTS):]
+      return path.split("/", 1)[-1]
+
 def copy_proto(ctx, descriptor, src):
     """Copy a proto to the 'staging area'
 
@@ -207,12 +212,18 @@ def copy_proto(ctx, descriptor, src):
     Returns:
       <Generated File> for the copied .proto
     """
-    proto = ctx.actions.declare_file(_get_proto_filename(src), sibling = descriptor)
+
+    if is_in_virtual_imports(src):
+        proto_rpath = _strip_virtual_import(src.path)
+    else:
+        proto_rpath = _get_proto_filename(src)
+    proto_copy_path = "/".join([descriptor.dirname, proto_rpath])
+    proto = ctx.actions.declare_file(proto_rpath, sibling = descriptor)
     ctx.actions.run_shell(
         mnemonic = "CopyProto",
         inputs = [src],
         outputs = [proto],
-        command = "cp %s %s" % (src.path, proto.path),
+        command = "cp %s %s" % (src.path, proto_copy_path),
     )
     return proto
 
@@ -700,3 +711,21 @@ def invoke_transitive(proto_compile_rule, name_suffix, kwargs):
     )
 
     return rule_name
+
+# From https://github.com/grpc/grpc/blob/2e7d6b94eaf6b0e11add27606b4fe3d0b7216154/bazel/protobuf.bzl:
+
+_VIRTUAL_IMPORTS = "/_virtual_imports/"
+
+def is_in_virtual_imports(source_file, virtual_folder = _VIRTUAL_IMPORTS):
+    """Determines if source_file is virtual (is placed in _virtual_imports
+    subdirectory). The output of all proto_library targets which use
+    import_prefix  and/or strip_import_prefix arguments is placed under
+    _virtual_imports directory.
+    Args:
+        source_file: A proto file.
+        virtual_folder: The virtual folder name (is set to "_virtual_imports"
+            by default)
+    Returns:
+        True if source_file is located under _virtual_imports, False otherwise.
+    """
+    return not source_file.is_source and virtual_folder in source_file.path

base-commit: 734b8d41d39a903c70132828616f26cb2c7f908c
-- 
2.25.0

